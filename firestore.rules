rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthed() && request.auth.uid == uid;
    }

    function ownerMatchesUid(uid) {
      return request.resource.data.ownerUid == uid;
    }

    function ownerUnchanged() {
      return request.resource.data.ownerUid == resource.data.ownerUid;
    }

    function isRoutineType(v) {
      return v == 'AB' || v == 'PPL';
    }

    function isGymModule(v) {
      return v == 'GYM';
    }

    function isSetDataValid(data) {
      return data.reps is int
        && data.reps >= 1
        && data.weightKg is number
        && data.weightKg >= 0
        && (!('rpe' in data) || (data.rpe is number && data.rpe >= 1 && data.rpe <= 10))
        && (!('machineId' in data) || data.machineId is string)
        && (!('machineLabel' in data) || data.machineLabel is string);
    }

    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid);
      allow update: if isOwner(uid)
        && (!('selectedModule' in request.resource.data) || isGymModule(request.resource.data.selectedModule));
      allow delete: if false;

      match /exercises/{exerciseId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid)
          && ownerMatchesUid(uid)
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0;
        allow update: if isOwner(uid)
          && ownerUnchanged()
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0;
        allow delete: if isOwner(uid);

        match /machines/{machineId} {
          allow read: if isOwner(uid);
          allow create: if isOwner(uid)
            && ownerMatchesUid(uid)
            && request.resource.data.label is string
            && request.resource.data.label.size() > 0;
          allow update: if isOwner(uid)
            && ownerUnchanged()
            && request.resource.data.label is string
            && request.resource.data.label.size() > 0;
          allow delete: if isOwner(uid);
        }
      }

      match /routines/{routineId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid)
          && ownerMatchesUid(uid)
          && isRoutineType(request.resource.data.type);
        allow update: if isOwner(uid)
          && ownerUnchanged()
          && isRoutineType(request.resource.data.type);
        allow delete: if isOwner(uid);

        match /days/{dayId} {
          allow read: if isOwner(uid);
          allow create: if isOwner(uid)
            && ownerMatchesUid(uid);
          allow update: if isOwner(uid)
            && ownerUnchanged();
          allow delete: if isOwner(uid);

          match /exercises/{exerciseItemId} {
            allow read: if isOwner(uid);
            allow create: if isOwner(uid)
              && ownerMatchesUid(uid)
              && request.resource.data.exerciseId is string
              && request.resource.data.exerciseId.size() > 0;
            allow update: if isOwner(uid)
              && ownerUnchanged()
              && request.resource.data.exerciseId is string
              && request.resource.data.exerciseId.size() > 0;
            allow delete: if isOwner(uid);
          }
        }
      }

      match /workoutSessions/{sessionId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid)
          && ownerMatchesUid(uid);
        allow update: if isOwner(uid)
          && ownerUnchanged();
        allow delete: if isOwner(uid);

        match /exercises/{sessionExerciseId} {
          allow read: if isOwner(uid);
          allow create: if isOwner(uid)
            && ownerMatchesUid(uid)
            && request.resource.data.nameSnapshot is string
            && request.resource.data.nameSnapshot.size() > 0;
          allow update: if isOwner(uid)
            && ownerUnchanged()
            && request.resource.data.nameSnapshot is string
            && request.resource.data.nameSnapshot.size() > 0;
          allow delete: if isOwner(uid);

          match /sets/{setId} {
            allow read: if isOwner(uid);
            allow create: if isOwner(uid)
              && ownerMatchesUid(uid)
              && isSetDataValid(request.resource.data);
            allow update: if isOwner(uid)
              && ownerUnchanged()
              && isSetDataValid(request.resource.data);
            allow delete: if isOwner(uid);
          }
        }
      }
    }
  }
}
